jQuery(function(c){var o=c("#woocommerce-order-items"),i=!1,n={handle_events:function(){o.on("click","button.configure_composite",{action:"configure"},this.clicked_edit_button).on("click","button.edit_composite",{action:"edit"},this.clicked_edit_button)},clicked_edit_button:function(e){var t=c.WCBackboneModal.View.extend({addButton:n.clicked_done_button}),o=c(this).closest("tr.item").attr("data-order_item_id");return i=new t({target:"wc-modal-edit-composite",string:{action:"configure"===e.data.action?wc_composite_admin_order_params.i18n_configure:wc_composite_admin_order_params.i18n_edit,item_id:o}}),n.populate_form(),!1},clicked_done_button:function(t){n.block(i.$el.find(".wc-backbone-modal-content"));var e=c.extend({},n.get_taxable_address(),{action:"woocommerce_edit_composite_in_order",item_id:i._string.item_id,fields:i.$el.find("input, select, textarea").serialize(),dataType:"json",order_id:woocommerce_admin_meta_boxes.post_id,security:wc_composite_admin_order_params.edit_composite_nonce});c.post(woocommerce_admin_meta_boxes.ajax_url,e,function(e){e.result&&"success"===e.result?(o.find(".inside").empty(),o.find(".inside").append(e.html),"yes"===wc_composite_admin_order_params.is_wc_version_gte_3_4?o.trigger("wc_order_items_reloaded"):(n.core.init_tiptip(),n.core.stupidtable.init()),"yes"===wc_composite_admin_order_params.is_wc_version_gte_3_6&&e.notes_html&&(c("ul.order_notes").empty(),c("ul.order_notes").append(c(e.notes_html).find("li"))),n.unblock(i.$el.find(".wc-backbone-modal-content")),n.block(o,{fadeIn:0}),setTimeout(function(){n.unblock(o)},250),i.closeButton(t)):(window.alert(e.error?e.error:wc_composite_admin_order_params.i18n_validation_error),n.unblock(i.$el.find(".wc-backbone-modal-content")))})},populate_form:function(){n.block(i.$el.find(".wc-backbone-modal-content"));var e={action:"woocommerce_configure_composite_order_item",item_id:i._string.item_id,dataType:"json",order_id:woocommerce_admin_meta_boxes.post_id,security:wc_composite_admin_order_params.edit_composite_nonce};c.post(woocommerce_admin_meta_boxes.ajax_url,e,function(e){if(e.result&&"success"===e.result){var t=i.$el.find("form");t.html(e.html),t.sw_select2(),i.$el.find(".composite_component").each(function(){new _(c(this))}),n.unblock(i.$el.find(".wc-backbone-modal-content"))}else window.alert(wc_composite_admin_order_params.i18n_form_error),n.unblock(i.$el.find(".wc-backbone-modal-content")),i.$el.find(".modal-close").trigger("click")})},get_taxable_address:function(){var e="",t="",o="",i="";return"shipping"===woocommerce_admin_meta_boxes.tax_based_on&&(e=c("#_shipping_country").val(),t=c("#_shipping_state").val(),o=c("#_shipping_postcode").val(),i=c("#_shipping_city").val()),"billing"!==woocommerce_admin_meta_boxes.tax_based_on&&e||(e=c("#_billing_country").val(),t=c("#_billing_state").val(),o=c("#_billing_postcode").val(),i=c("#_billing_city").val()),{country:e,state:t,postcode:o,city:i}},block:function(e,t){var o=c.extend({},{message:null,overlayCSS:{background:"#fff",opacity:.6}},t||{});e.block(o)},unblock:function(e){e.unblock()}};"no"===wc_composite_admin_order_params.is_wc_version_gte_3_4&&(n.core={init_tiptip:function(){c("#tiptip_holder").removeAttr("style"),c("#tiptip_arrow").removeAttr("style"),c(".tips").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:200})},stupidtable:{init:function(){c(".woocommerce_order_items").stupidtable(),c(".woocommerce_order_items").on("aftertablesort",this.add_arrows)},add_arrows:function(e,t){var o=c(this).find("th"),i="asc"===t.direction?"&uarr;":"&darr;",n=t.column;o.find(".wc-arrow").remove(),o.eq(n).append('<span class="wc-arrow">'+i+"</span>")}}}),n.handle_events();var _=function(e){var t=this;this.$selection_el=e.find("select.component_option_select"),this.$view_el=e.find(".component_option_selection_details_wrapper"),this.component_id=e.data("component_data").component_id,this.composite_id=e.data("component_data").composite_id;var o=Backbone.Model.extend({selected_product_data:{product_html:""},initialize:function(){this.set({selected_product:t.$selection_el.val()})},update_selection:function(e){e?this.load_selection_data(e):this.update_selected_product("",{product_html:""})},load_selection_data:function(o){var i=this,e={action:"woocommerce_get_composited_product_data",product_id:o,component_id:t.component_id,composite_id:t.composite_id};c.ajax({type:"POST",url:woocommerce_admin_meta_boxes.ajax_url,data:e,timeout:15e3,dataType:"json",success:function(e){if("success"===e.result){var t=e.product_data;i.trigger("selected_product_data_loaded",o,t),i.update_selected_product(o,t)}else i.trigger("selected_product_data_load_error",o)},error:function(){i.trigger("selected_product_data_load_error",o)}})},update_selected_product:function(e,t){this.selected_product_data=t,this.set({selected_product:e})},get_selected_product_data:function(){return this.selected_product_data}}),i=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"change:selected_product",this.render),this.listenTo(this.model,"selected_product_data_load_error",this.selection_data_load_error),t.$selection_el.on("change",this.selection_changed)},selection_changed:function(){var e=c(this).val()||"";if(t.selection_model.get("selected_product")===e)return!1;e?(t.selection_view.block(),t.selection_model.update_selection(e)):t.selection_model.update_selection("")},render:function(){t.$view_el.html(this.model.get_selected_product_data().product_html),this.model.get("selected_product")&&this.unblock()},selection_data_load_error:function(){var e=this.model.get("selected_product");window.alert(wc_composite_admin_order_params.i18n_selection_request_timeout),t.$selection_el.val(e).change(),this.unblock()},block:function(){n.block(t.$view_el)},unblock:function(){n.unblock(t.$view_el)}});this.selection_model=new o,this.selection_view=new i({el:t.$view_el,model:t.selection_model})}});